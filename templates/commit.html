from flask import Flask, jsonify, render_template
import requests
from datetime import datetime
from collections import Counter

app = Flask(__name__)

# Étape 1 : Extraire les données des commits
def get_commit_minutes():
    url = "https://api.github.com/repos/OpenRSI/5MCSI_Metriques/commits"
    response = requests.get(url)
    commits = response.json()

    # Étape 2 : Extraire les minutes des timestamps
    minutes = []
    for commit in commits:
        date_string = commit['commit']['author']['date']
        date_object = datetime.strptime(date_string, '%Y-%m-%dT%H:%M:%SZ')
        minutes.append(date_object.minute)

    # Étape 3 : Compter les commits par minute
    count_by_minute = Counter(minutes)
    return count_by_minute

# Route principale pour afficher le graphique
@app.route('/commits/')
def commits_chart():
    data = get_commit_minutes()
    return render_template('commits_chart.html', data=data)

# Route pour extraire les minutes (Indice N°3)
@app.route('/extract-minutes/<date_string>')
def extract_minutes(date_string):
    date_object = datetime.strptime(date_string, '%Y-%m-%dT%H:%M:%SZ')
    minutes = date_object.minute
    return jsonify({'minutes': minutes})

if __name__ == "__main__":
    app.run(debug=True)
